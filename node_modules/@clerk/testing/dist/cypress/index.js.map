{"version":3,"sources":["../../src/cypress/index.ts","../../src/common/constants.ts","../../src/common/setup.ts","../../src/common/errors.ts","../../src/common/helpers-utils.ts","../../src/cypress/setup.ts","../../src/cypress/setupClerkTestingToken.ts","../../src/cypress/custom-commands.ts"],"sourcesContent":["export { clerkSetup } from './setup';\nexport { setupClerkTestingToken } from './setupClerkTestingToken';\nexport { addClerkCommands } from './custom-commands';\n","export const TESTING_TOKEN_PARAM = '__clerk_testing_token';\n","import { createClerkClient } from '@clerk/backend';\nimport { isProductionFromSecretKey, parsePublishableKey } from '@clerk/shared/keys';\nimport dotenv from 'dotenv';\n\nimport type { ClerkSetupOptions, ClerkSetupReturn } from './types';\n\nexport const fetchEnvVars = async (options?: ClerkSetupOptions): Promise<ClerkSetupReturn> => {\n  const log = (msg: string) => {\n    if (options?.debug) {\n      console.log(`Clerk: ${msg}`);\n    }\n  };\n\n  log('Setting up Clerk...');\n  dotenv.config({ path: ['.env.local', '.env'] });\n\n  const publishableKey =\n    options?.publishableKey ||\n    process.env.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY ||\n    process.env.VITE_CLERK_PUBLISHABLE_KEY ||\n    process.env.CLERK_PUBLISHABLE_KEY ||\n    process.env.REACT_APP_CLERK_PUBLISHABLE_KEY ||\n    process.env.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY;\n\n  const secretKey = process.env.CLERK_SECRET_KEY;\n  let testingToken = process.env.CLERK_TESTING_TOKEN;\n\n  if (!publishableKey) {\n    throw new Error('You need to set the CLERK_PUBLISHABLE_KEY environment variable.');\n  }\n\n  if (!secretKey && !testingToken) {\n    throw new Error('You need to set the CLERK_SECRET_KEY or the CLERK_TESTING_TOKEN environment variable.');\n  }\n\n  if (secretKey && !testingToken) {\n    if (isProductionFromSecretKey(secretKey)) {\n      throw new Error(\n        'You are using a secret key from a production instance, but Testing Tokens only work in development instances.',\n      );\n    }\n\n    log('Fetching testing token from Clerk Backend API...');\n\n    try {\n      const apiUrl = process.env.CLERK_API_URL;\n      const clerkClient = createClerkClient({ secretKey, apiUrl });\n      const tokenData = await clerkClient.testingTokens.createTestingToken();\n      testingToken = tokenData.token;\n    } catch (err) {\n      console.error('Failed to fetch testing token from Clerk API.');\n      throw err;\n    }\n  }\n\n  return {\n    CLERK_FAPI: options?.frontendApiUrl || parsePublishableKey(publishableKey)?.frontendApi,\n    CLERK_TESTING_TOKEN: testingToken,\n  };\n};\n","export const ERROR_MISSING_FRONTEND_API_URL =\n  'The Clerk Frontend API URL is required to bypass bot protection. ' +\n  'Make sure the clerkSetup function is called during your global setup before setupClerkTestingToken is called.';\n","import type { EmailCodeFactor, PhoneCodeFactor, SignInFirstFactor } from '@clerk/types';\n\nimport type { SignInHelperParams } from './types';\n\n// This function is serialized and executed in the browser context\nexport const signInHelper = async ({ signInParams, windowObject }: SignInHelperParams) => {\n  try {\n    const w = windowObject || window;\n    if (!w.Clerk.client) {\n      return;\n    }\n    const signIn = w.Clerk.client.signIn;\n    if (signInParams.strategy === 'password') {\n      const res = await signIn.create(signInParams);\n      await w.Clerk.setActive({\n        session: res.createdSessionId,\n      });\n    } else {\n      // Assert that the identifier is a test email or phone number\n      if (signInParams.strategy === 'phone_code' && !signInParams.identifier.includes('+155555501')) {\n        throw new Error(\n          `Phone number should be a test phone number.\\n\n       Example: +15555550100.\\n\n       Learn more here: https://clerk.com/docs/testing/test-emails-and-phones#phone-numbers`,\n        );\n      }\n      if (signInParams.strategy === 'email_code' && !signInParams.identifier.includes('+clerk_test')) {\n        throw new Error(\n          `Email should be a test email.\\n\n       Any email with the +clerk_test subaddress is a test email address.\\n\n       Learn more here: https://clerk.com/docs/testing/test-emails-and-phones#email-addresses`,\n        );\n      }\n\n      // Sign in with code (email_code or phone_code)\n      const { supportedFirstFactors } = await signIn.create({\n        identifier: signInParams.identifier,\n      });\n      const codeFactorFn =\n        signInParams.strategy === 'phone_code'\n          ? (factor: SignInFirstFactor): factor is PhoneCodeFactor => factor.strategy === 'phone_code'\n          : (factor: SignInFirstFactor): factor is EmailCodeFactor => factor.strategy === 'email_code';\n      const codeFactor = supportedFirstFactors?.find(codeFactorFn);\n      if (codeFactor) {\n        const prepareParams =\n          signInParams.strategy === 'phone_code'\n            ? { strategy: signInParams.strategy, phoneNumberId: (codeFactor as PhoneCodeFactor).phoneNumberId }\n            : { strategy: signInParams.strategy, emailAddressId: (codeFactor as EmailCodeFactor).emailAddressId };\n\n        await signIn.prepareFirstFactor(prepareParams);\n        const signInAttempt = await signIn.attemptFirstFactor({\n          strategy: signInParams.strategy,\n          code: '424242',\n        });\n\n        if (signInAttempt.status === 'complete') {\n          await w.Clerk.setActive({ session: signInAttempt.createdSessionId });\n        } else {\n          throw new Error(`Status is ${signInAttempt.status}`);\n        }\n      } else {\n        throw new Error(`${signInParams.strategy} is not enabled.`);\n      }\n    }\n  } catch (err: any) {\n    throw new Error(`Clerk: Failed to sign in: ${err?.message}`);\n  }\n};\n","/// <reference types=\"cypress\" />\nimport type { ClerkSetupOptions } from '../common';\nimport { fetchEnvVars } from '../common';\n\ntype ClerkSetupParams = {\n  config: Cypress.PluginConfigOptions;\n  options?: ClerkSetupOptions;\n};\n\n/**\n * Sets up Clerk for testing by fetching the testing token from the Clerk Backend API.\n *\n * @param config - The Cypress config object.\n * @param options - The Clerk setup options.\n * @param options.publishableKey - The publishable key for your Clerk dev instance.\n * @param options.frontendApiUrl - The frontend API URL for your Clerk dev instance, without the protocol. It overrides the Frontend API URL parsed from the publishable key.\n * @param options.debug - Enable debug logs.\n * @returns The Cypress config object with the Clerk environment variables set.\n *\n * @throws An error if the publishable key or the secret key is not provided.\n * @throws An error if the secret key is from a production instance.\n * @throws An error if the testing token cannot be fetched from the Clerk Backend API.\n * @throws An error if the Cypress config object is not provided.\n */\nexport const clerkSetup = async ({ config, options }: ClerkSetupParams) => {\n  if (!config) {\n    throw new Error('The Cypress config object is required.');\n  }\n  const { CLERK_FAPI, CLERK_TESTING_TOKEN } = await fetchEnvVars(options);\n  config.env.CLERK_FAPI = CLERK_FAPI;\n  config.env.CLERK_TESTING_TOKEN = CLERK_TESTING_TOKEN;\n  return config;\n};\n","/// <reference types=\"cypress\" />\nimport type { SetupClerkTestingTokenOptions } from '../common';\nimport { ERROR_MISSING_FRONTEND_API_URL, TESTING_TOKEN_PARAM } from '../common';\n\ntype SetupClerkTestingTokenParams = {\n  options?: SetupClerkTestingTokenOptions;\n};\n\n/**\n * Bypasses bot protection by appending the testing token in the Frontend API requests.\n *\n * @param params.options.frontendApiUrl - The frontend API URL for your Clerk dev instance, without the protocol.\n * @returns A promise that resolves when the bot protection bypass is set up.\n * @throws An error if the Frontend API URL is not provided.\n * @example\n * import { setupClerkTestingToken } from '@clerk/testing/cypress';\n *\n * it(\"sign up\", () => {\n *     setupClerkTestingToken();\n *     cy.visit(\"http://localhost:3000\");\n *     // Continue with your test...\n * });\n */\nexport const setupClerkTestingToken = (params?: SetupClerkTestingTokenParams) => {\n  const fapiUrl = params?.options?.frontendApiUrl || Cypress.env('CLERK_FAPI');\n  if (!fapiUrl) {\n    throw new Error(ERROR_MISSING_FRONTEND_API_URL);\n  }\n  const apiUrl = `https://${fapiUrl}/v1/**`;\n\n  cy.intercept(apiUrl, req => {\n    const testingToken = Cypress.env('CLERK_TESTING_TOKEN');\n    if (testingToken) {\n      req.query[TESTING_TOKEN_PARAM] = testingToken;\n    }\n    req.continue();\n  });\n};\n","/// <reference types=\"cypress\" />\nimport type { Clerk, SignOutOptions } from '@clerk/types';\n\nimport type { ClerkSignInParams } from '../common';\nimport { signInHelper } from '../common';\nimport { setupClerkTestingToken } from './setupClerkTestingToken';\n\ndeclare global {\n  // eslint-disable-next-line @typescript-eslint/no-namespace\n  namespace Cypress {\n    interface Chainable {\n      /**\n       * Signs in a user using Clerk. This custom command supports only password, phone_code and email_code first factor strategies.\n       * Multi-factor is not supported.\n       * This helper is using the `setupClerkTestingToken` internally.\n       * It is required to call `cy.visit` before calling this command, and navigate to a not protected page that loads Clerk.\n       *\n       * If the strategy is password, the command will sign in the user using the provided password and identifier.\n       * If the strategy is phone_code, you are required to have a user with a test phone number as an identifier (e.g. +15555550100).\n       * If the strategy is email_code, you are required to have a user with a test email as an identifier (e.g. your_email+clerk_test@example.com).\n       *\n       * @param signInParams - The sign in parameters.\n       * @param signInParams.strategy - The sign in strategy. Supported strategies are 'password', 'phone_code' and 'email_code'.\n       * @param signInParams.identifier - The user's identifier. Could be a username, a phone number or an email.\n       * @param signInParams.password - The user's password. Required only if the strategy is 'password'.\n       *\n       * @example\n       *  it(\"sign in\", () => {\n       *     cy.visit(`/`);\n       *     cy.clerkSignIn({ strategy: 'phone_code', identifier: '+15555550100' });\n       *     cy.visit('/protected');\n       *  });\n       */\n      clerkSignIn(signInParams: ClerkSignInParams): Chainable<void>;\n\n      /**\n       * Signs out the current user using Clerk.\n       * It is required to call `cy.visit` before calling this command, and navigate to a page that loads Clerk.\n       * @param signOutOptions - A SignOutOptions object.\n       *\n       * @example\n       *  it(\"sign out\", () => {\n       *     cy.visit(`/`);\n       *     cy.clerkSignIn({ strategy: 'phone_code', identifier: '+15555550100' });\n       *     cy.visit('/protected');\n       *     cy.clerkSignOut();\n       *  });\n       */\n      clerkSignOut(signOutOptions?: SignOutOptions): Chainable<void>;\n\n      /**\n       * Asserts that Clerk has been loaded.\n       * It is required to call `cy.visit` before calling this command, and navigate to a page that loads Clerk.\n       */\n      clerkLoaded(): Chainable<void>;\n    }\n  }\n  interface Window {\n    Clerk: Clerk;\n  }\n}\n\ntype AddClerkCommandsParams = {\n  Cypress: typeof Cypress;\n  cy: Cypress.Chainable;\n};\n\nexport const addClerkCommands = ({ Cypress, cy }: AddClerkCommandsParams) => {\n  Cypress.Commands.add(`clerkSignIn`, signInParams => {\n    setupClerkTestingToken();\n    cy.log(`Clerk: Signing in...`);\n\n    cy.window()\n      .should(window => {\n        expect(window).to.not.have.property(`Clerk`, undefined);\n        expect(window.Clerk.loaded).to.eq(true);\n      })\n      .then(async window => {\n        await signInHelper({ windowObject: window, signInParams });\n        cy.log(`Clerk: Finished signing in.`);\n      });\n  });\n\n  Cypress.Commands.add(`clerkSignOut`, signOutOptions => {\n    cy.log(`Clerk: Signing out...`);\n\n    cy.window()\n      .should(window => {\n        expect(window).to.not.have.property(`Clerk`, undefined);\n        expect(window.Clerk.loaded).to.eq(true);\n      })\n      .then(async window => {\n        await window.Clerk.signOut(signOutOptions);\n        cy.log(`Clerk: Finished signing out.`);\n      });\n  });\n\n  Cypress.Commands.add(`clerkLoaded`, () => {\n    cy.window().should(window => {\n      expect(window).to.not.have.property(`Clerk`, undefined);\n      expect(window.Clerk.loaded).to.eq(true);\n    });\n  });\n};\n"],"mappings":"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","names":["cypress_exports","__export","addClerkCommands","clerkSetup","setupClerkTestingToken","__toCommonJS","TESTING_TOKEN_PARAM","import_backend","import_keys","import_dotenv","fetchEnvVars","options","log","msg","dotenv","publishableKey","secretKey","testingToken","apiUrl","err","ERROR_MISSING_FRONTEND_API_URL","signInHelper","signInParams","windowObject","w","signIn","res","supportedFirstFactors","codeFactorFn","factor","codeFactor","prepareParams","signInAttempt","err","clerkSetup","config","options","CLERK_FAPI","CLERK_TESTING_TOKEN","fetchEnvVars","setupClerkTestingToken","params","fapiUrl","ERROR_MISSING_FRONTEND_API_URL","apiUrl","req","testingToken","TESTING_TOKEN_PARAM","addClerkCommands","Cypress","cy","signInParams","setupClerkTestingToken","window","signInHelper","signOutOptions"]}